<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Solicitações de representantes - OD Drive</title>
  <link rel="stylesheet" href="../../styles/theme.css">
  <link rel="stylesheet" href="../../styles/globals.css">
  <style>
    body{margin:0;background:#f6f7f8;font-family:"Work Sans",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:#101922;}
    .shell{width:min(1100px,94vw);margin:24px auto;padding-bottom:32px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
    .top h1{margin:0;font-size:22px;}
    .card{background:#fff;border:1px solid #e6e9ed;border-radius:16px;box-shadow:0 6px 24px rgba(16,25,34,0.06),0 2px 8px rgba(16,25,34,0.04);padding:16px;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 8px;border-bottom:1px solid #e6e9ed;text-align:left;font-size:14px;}
    th{color:#6b7785;text-transform:uppercase;font-size:12px;letter-spacing:.2px;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid #cfe3fb;background:#e5f0fb;color:#1173d4;}
    .pill.conv{background:#eaf8f1;border-color:#cceede;color:#167347;}
    .pill.av{background:#fff4e0;border-color:#ffe1aa;color:#e39225;}
    .pill.novo{background:#eef1f4;border-color:#e6e9ed;color:#101922;}
    .btn{appearance:none;border:1px solid transparent;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;transition:.14s ease;}
    .btn.primary{background:#1173d4;color:#fff;}
    .btn.ghost{background:#fff;border-color:#e6e9ed;color:#101922;}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(16,25,34,0.10);}
    .badge{font-size:12px;color:#6b7785;}
    .empty{padding:16px;color:#6b7785;text-align:center;}
    @media(max-width:780px){table,thead,tbody,tr,td,th{display:block;}th{display:none;}td{border-bottom:1px solid #e6e9ed;margin-bottom:8px;}}
    
    /* Modal de confirmação */
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(16,25,34,0.75);z-index:9999;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal-box{background:#fff;border-radius:16px;box-shadow:0 24px 48px rgba(16,25,34,0.2);width:min(420px,90vw);padding:28px;}
    .modal-header{margin-bottom:20px;}
    .modal-header h2{margin:0 0 8px 0;font-size:20px;color:#101922;}
    .modal-header p{margin:0;font-size:14px;color:#6b7785;}
    .modal-body{margin-bottom:20px;}
    .form-field{margin-bottom:14px;}
    .form-field label{display:block;font-weight:700;margin-bottom:6px;font-size:13px;color:#3d4753;}
    .form-field input{width:100%;padding:11px 12px;border:1px solid #e6e9ed;border-radius:10px;font:inherit;box-sizing:border-box;font-size:14px;}
    .form-field input:focus{outline:none;border-color:#1173d4;box-shadow:0 0 0 3px rgba(17,115,212,0.18);}
    .modal-error{background:#ffeaea;border:1px solid #ffc7c7;color:#c0392b;padding:10px;border-radius:8px;font-size:13px;margin-bottom:14px;display:none;}
    .modal-error.show{display:block;}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;}
    .modal-actions .btn{min-width:100px;}
  </style>
</head>
<body>
  <div class="shell">
    <div class="top">
      <div>
        <h1>Solicitações de representantes</h1>
        <div class="badge">Novas entradas chegam aqui para curadoria do time.</div>
      </div>
      <button id="refreshBtn" class="btn ghost">Atualizar</button>
    </div>
    <div class="card" id="listCard">
      <div id="tableWrap"></div>
    </div>
  </div>

  <!-- Modal de confirmação para remover -->
  <div class="modal-overlay" id="removeModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2>Confirmar remoção</h2>
        <p>Digite suas credenciais para confirmar a remoção desta solicitação.</p>
      </div>
      <div class="modal-body">
        <div class="modal-error" id="removeError"></div>
        <form id="removeForm">
          <div class="form-field">
            <label for="removeUsername">Usuário</label>
            <input type="text" id="removeUsername" name="username" required autocomplete="username">
          </div>
          <div class="form-field">
            <label for="removePassword">Senha</label>
            <input type="password" id="removePassword" name="password" required autocomplete="current-password">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn ghost" id="cancelRemove">Cancelar</button>
            <button type="submit" class="btn primary" id="confirmRemove" style="background:#c0392b;border-color:#c0392b;">Remover</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const tableWrap = document.getElementById('tableWrap');
    const refreshBtn = document.getElementById('refreshBtn');

    function getApiBase() {
      // Em produção (Render), usar origem sem porta
      if (window.location.hostname.includes('onrender.com')) {
        return window.location.origin;
      }
      // Em desenvolvimento local, usar porta 5173
      if (window.location.port === '5173') {
        return window.location.origin;
      }
      // Fallback para desenvolvimento local
      return 'http://localhost:5173';
    }

    function badge(status){
      const map = {convertida:'pill conv', em_avaliacao:'pill av', aprovado:'pill av', novo:'pill novo'};
      const label = {
        convertida:'Convertida',
        em_avaliacao:'Em avaliação',
        aprovado:'Aprovada',
        novo:'Nova'
      }[status] || status;
      return `<span class="${map[status]||'pill'}">${label}</span>`;
    }

    async function fetchList() {
      tableWrap.innerHTML = '<div class="empty">Carregando...</div>';
      try {
        const res = await fetch(`${getApiBase()}/api/representatives/requests`);
        const data = await res.json();
        renderTable(data || []);
      } catch (err) {
        console.error(err);
        tableWrap.innerHTML = '<div class="empty">Erro ao carregar. Verifique a API.</div>';
      }
    }

    function renderTable(list){
      if (!list.length){
        tableWrap.innerHTML = '<div class="empty">Nenhuma solicitação no momento.</div>';
        return;
      }
      const rows = list.map(item => {
        const created = item.createdAt ? new Date(item.createdAt).toLocaleString('pt-BR') : '--';
        return `
          <tr>
            <td><strong>${item.anunciante || item.empresa || 'Sem nome'}</strong><br><small>${item.pracas || ''}</small></td>
            <td>${item.representanteNome}<br><small>${item.representanteEmail}</small></td>
            <td>${item.numeroCarros || '--'}</td>
            <td>${item.tempoCampanhaDias || '--'}</td>
            <td>${badge(item.status)}</td>
            <td>${created}</td>
            <td>
              <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <button class="btn primary" onclick="convert('${item.id}')">Gerar minuta</button>
                <button class="btn ghost" onclick="mark('${item.id}','em_avaliacao')">Em avaliação</button>
                <button class="btn ghost" onclick="mark('${item.id}','aprovado')">Aprovar</button>
                <button class="btn ghost" onclick="removeRequest('${item.id}')" style="background:#c0392b;color:#fff;border-color:#c0392b;">Remover</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tableWrap.innerHTML = `
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Representante</th>
                <th>Carros</th>
                <th>Dias</th>
                <th>Status</th>
                <th>Recebido</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    async function mark(id, status){
      await fetch(`${getApiBase()}/api/representatives/requests/${id}/status`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({status})
      }).catch(()=>{});
      fetchList();
    }

    async function convert(id){
      const res = await fetch(`${getApiBase()}/api/representatives/requests/${id}/convert`, { method:'POST' });
      const body = await res.json().catch(()=> ({}));
      if (res.ok) {
        alert('Minuta criada. ID: ' + (body.proposalId || 'novo'));
        fetchList();
      } else {
        alert(body.error || 'Falha ao converter.');
      }
    }

    function removeRequest(id){
      currentRemoveId = id;
      removeModal.classList.add('show');
      removeUsername.value = '';
      removePassword.value = '';
      removeUsername.focus();
      hideRemoveError();
    }

    // Modal de remoção
    const removeModal = document.getElementById('removeModal');
    const removeForm = document.getElementById('removeForm');
    const removeUsername = document.getElementById('removeUsername');
    const removePassword = document.getElementById('removePassword');
    const cancelRemove = document.getElementById('cancelRemove');
    const confirmRemove = document.getElementById('confirmRemove');
    const removeError = document.getElementById('removeError');
    let currentRemoveId = null;

    function showRemoveError(msg) {
      removeError.textContent = msg;
      removeError.classList.add('show');
    }

    function hideRemoveError() {
      removeError.classList.remove('show');
    }

    function closeRemoveModal() {
      removeModal.classList.remove('show');
      currentRemoveId = null;
    }

    cancelRemove.addEventListener('click', closeRemoveModal);
    
    removeModal.addEventListener('click', (e) => {
      if (e.target === removeModal) closeRemoveModal();
    });

    removeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideRemoveError();

      const username = removeUsername.value.trim();
      const password = removePassword.value;

      if (!username || !password) {
        showRemoveError('Preencha usuário e senha.');
        return;
      }

      confirmRemove.disabled = true;
      confirmRemove.textContent = 'Verificando...';

      try {
        // Validar credenciais no backend
        const backendUrl = window.WORKSPACE_CONFIG 
          ? window.WORKSPACE_CONFIG.getBackendUrl() 
          : getApiBase().replace(':5173', ':5174');
        
        const authRes = await fetch(`${backendUrl}/api/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!authRes.ok) {
          showRemoveError('Credenciais inválidas.');
          confirmRemove.disabled = false;
          confirmRemove.textContent = 'Remover';
          return;
        }

        // Credenciais válidas, remover solicitação
        confirmRemove.textContent = 'Removendo...';
        const deleteRes = await fetch(`${getApiBase()}/api/representatives/requests/${currentRemoveId}`, {
          method: 'DELETE'
        });

        if (deleteRes.ok) {
          closeRemoveModal();
          fetchList();
        } else {
          const errBody = await deleteRes.json().catch(() => ({}));
          showRemoveError(errBody.error || 'Erro ao remover solicitação.');
          confirmRemove.disabled = false;
          confirmRemove.textContent = 'Remover';
        }
      } catch (err) {
        console.error(err);
        showRemoveError('Erro de conexão. Tente novamente.');
        confirmRemove.disabled = false;
        confirmRemove.textContent = 'Remover';
      }
    });

    refreshBtn.addEventListener('click', fetchList);
    fetchList();
  </script>
</body>
</html>
